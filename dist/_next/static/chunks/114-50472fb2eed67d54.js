"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[114],{2099:(e,r,t)=>{t.d(r,{ND:()=>i,aE:()=>d,bf:()=>u,ru:()=>c,t1:()=>p,x$:()=>m,zk:()=>l});var a=t(2354);let o="https://ugmfmnwbynppdzkhvrih.supabase.co",s="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnbWZtbndieW5wcGR6a2h2cmloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4ODE4NzAsImV4cCI6MjA3MTQ1Nzg3MH0.MTNKqQCzmRETjULZ2PRx8mTK3hpR90tn6Pz36h1nMR4";o||console.warn("NEXT_PUBLIC_SUPABASE_URL no est\xe1 definida. Verifica la configuraci\xf3n de la extensi\xf3n Supabase en Netlify."),s||console.warn("NEXT_PUBLIC_SUPABASE_ANON_KEY no est\xe1 definida. Verifica la configuraci\xf3n de la extensi\xf3n Supabase en Netlify.");let n=null,i=(o&&s?(n=(0,a.UU)(o,s,{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0},global:{headers:{"X-Client-Info":"rifa-silverado@1.0.0"}}}),console.log("✅ Supabase client initialized")):(console.error("❌ Variables de Supabase no disponibles en runtime"),n={}),n);async function l(){try{let{data:e,error:r}=await i.from("customers").select("count",{count:"exact",head:!0});if(r){if(console.error("❌ Error de conexi\xf3n Supabase:",r.message),r.message.includes("database is paused")||r.message.includes("project is paused")||r.message.includes("timeout"))throw console.error("\uD83D\uDEA8 Base de datos pausada. Revisa tu plan de Supabase."),Error("Base de datos pausada. Contacta al administrador o actualiza el plan.");return!1}return console.log("✅ Conexi\xf3n Supabase exitosa"),!0}catch(e){return console.error("❌ Error cr\xedtico de conexi\xf3n:",e),!1}}async function c(e){try{if(!await l())throw Error("No se pudo establecer conexi\xf3n con la base de datos. Intenta m\xe1s tarde.");console.log("\uD83D\uDCBE Guardando compra:",e);let{data:r,error:t}=await i.from("customers").insert([{name:`${e.nombre} ${e.apellidos}`,email:e.email,phone:e.telefono,city:e.ciudad,state:e.estado}]).select().single();if(t)throw console.error("❌ Error al crear cliente:",t),Error(`Error al crear cliente: ${t.message}`);let{data:a,error:o}=await i.from("purchases").insert([{customer_id:r.id,total_amount:e.precio_total,unit_price:e.precio_unitario,discount_applied:e.descuento_aplicado||0,payment_method:e.metodo_pago,payment_reference:e.referencia_pago,payment_proof_url:e.captura_comprobante_url,browser_info:e.navegador,device_info:e.dispositivo,ip_address:e.ip_address,user_agent:e.user_agent,status:"pendiente"}]).select().single();if(o)throw console.error("❌ Error al crear compra:",o),Error(`Error al crear compra: ${o.message}`);return console.log("✅ Compra guardada exitosamente"),{customer:r,purchase:a,tickets:[]}}catch(e){throw console.error("❌ Error completo en guardarCompra:",e),e}}function u(){return{navegador:navigator.userAgent,dispositivo:/Mobi|Android/i.test(navigator.userAgent)?"m\xf3vil":"escritorio",user_agent:navigator.userAgent,timestamp:new Date().toISOString(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,idioma:navigator.language,pantalla:`${screen.width}x${screen.height}`}}async function d(e,r){try{let t=new Date().getTime(),a=e.name.split(".").pop(),o=`capturas/${r.replace(/\s+/g,"_")}_${t}.${a}`,{data:s,error:n}=await i.storage.from("comprobantes").upload(o,e);if(n)throw console.error("❌ Error al subir archivo:",n),n;let{data:l}=i.storage.from("comprobantes").getPublicUrl(o);return console.log("✅ Archivo subido exitosamente"),l.publicUrl}catch(e){return console.error("❌ Error en subirCaptura:",e),null}}async function m(){try{let{data:e,error:r}=await i.from("purchases").select(`
        *,
        customer:customers(*),
        tickets(*)
      `).order("created_at",{ascending:!1});if(r)throw console.error("❌ Error al obtener compras:",r),r;return e}catch(e){throw console.error("❌ Error en obtenerCompras:",e),e}}async function p(e,r,t,a){try{let{data:o,error:s}=await i.from("purchases").select(`
        *,
        customer:customers(*)
      `).eq("id",e).single();if(s)throw s;let n={status:r,notes:t,verified_by:a};"confirmada"===r&&(n.verified_at=new Date().toISOString());let{data:l,error:c}=await i.from("purchases").update(n).eq("id",e).select().single();if(c)throw c;let u=[];if("confirmada"===r){let r=Math.round(l.total_amount/l.unit_price);try{u=await h(e,l.customer_id,r),console.log(`✅ Compra confirmada y ${u.length} tickets asignados`)}catch(r){throw console.error("❌ Error al asignar tickets:",r),await i.from("purchases").update({status:"pendiente"}).eq("id",e),Error(`No se pudo confirmar: ${r instanceof Error?r.message:"Error al asignar tickets"}`)}}"cancelada"===r&&(await i.from("tickets").update({status:"disponible",customer_id:null,purchase_id:null,sold_at:null}).eq("purchase_id",e),console.log("\uD83D\uDD04 Tickets liberados por cancelaci\xf3n"));let{data:d,error:m}=await i.from("purchases").select(`
        *,
        customer:customers(*),
        tickets(*)
      `).eq("id",e).single();if(m)throw m;return console.log("✅ Compra actualizada"),d}catch(e){throw console.error("❌ Error en actualizarEstadoCompra:",e),e}}async function h(e,r,t){try{let{data:a,error:o}=await i.from("tickets").select("*").eq("status","disponible").order("number").limit(t);if(o)throw o;if(!a||a.length<t)throw Error(`Solo hay ${a?.length||0} tickets disponibles, necesitas ${t}`);let s=a.map(e=>e.number),n=new Date().toISOString(),{data:l,error:c}=await i.from("tickets").update({status:"vendido",customer_id:r,purchase_id:e,sold_at:n}).in("number",s).select();if(c)throw c;return console.log(`✅ Asignados ${l?.length} tickets:`,s),l||[]}catch(e){throw console.error("❌ Error al asignar n\xfameros:",e),e}}},9114:(e,r,t)=>{t.d(r,{x:()=>i});var a=t(2115),o=t(2099),s=t(5726),n=t(1530);function i(){let[e,r]=(0,a.useState)(!1),[t,i]=(0,a.useState)(!0),[l,c]=(0,a.useState)(8),{_updateAvailableTickets:u,setSoldTicketsFromDB:d,setReservedTicketsFromDB:m}=(0,s.vW)(e=>({_updateAvailableTickets:e._updateAvailableTickets,setSoldTicketsFromDB:e.setSoldTicketsFromDB,setReservedTicketsFromDB:e.setReservedTicketsFromDB})),p=async()=>{try{i(!0);let e=await (0,o.zk)();if(r(e),!e){console.warn("Supabase no disponible, usando datos locales"),n.default.error("Base de datos no disponible, usando modo offline"),i(!1);return}let{data:t,error:a}=await o.ND.from("tickets").select("number").eq("status","vendido");if(a)console.error("Error al obtener tickets vendidos:",a),n.default.error("Error al cargar tickets vendidos");else{let e=t?.map(e=>e.number)||[],r=(e=>{if(e.length/1e4*100>=18)return e;let r=Math.max(0,Math.floor(l/100*1e4)-e.length);if(0===r)return e;let t=new Set(e),a=[];for(;a.length<r;){let e=Math.floor(1e4*Math.random())+1;t.has(e)||a.includes(e)||a.push(e)}let o=[...e,...a].sort((e,r)=>e-r);return console.log(`FOMO System: ${e.length} real + ${a.length} FOMO = ${o.length} total (${l}%)`),o})(e);d(r),console.log(`Cargados ${e.length} tickets reales, mostrando ${r.length} (${l}%)`)}let{data:s,error:c}=await o.ND.from("tickets").select("number").eq("status","reservado");if(c)console.error("Error al obtener tickets reservados:",c);else{let e=s?.map(e=>e.number)||[];m(e)}setTimeout(()=>{u()},100),n.default.success(`Datos sincronizados: ${l}% vendido`)}catch(e){console.error("Error al cargar datos iniciales:",e),n.default.error("Error al sincronizar con la base de datos"),r(!1)}finally{i(!1)}};(0,a.useEffect)(()=>{let e=setInterval(()=>{let e=Math.min(18,8+Math.min(2,Math.floor(Date.now()/18e5))+3*Math.random());Math.abs(e-l)>.5&&c(Math.floor(e))},12e4);return()=>clearInterval(e)},[l]),(0,a.useEffect)(()=>{if(!e)return;console.log("Configurando suscripciones en tiempo real...");let r=o.ND.channel("tickets-changes").on("postgres_changes",{event:"*",schema:"public",table:"tickets"},e=>{console.log("Cambio en tickets:",e),p()}).subscribe(),t=o.ND.channel("purchases-changes").on("postgres_changes",{event:"*",schema:"public",table:"purchases"},e=>{console.log("Cambio en compras:",e),"INSERT"===e.eventType&&n.default.success("\xa1Nueva compra registrada!",{duration:3e3,icon:"\uD83C\uDF89"})}).subscribe();return()=>{o.ND.removeChannel(r),o.ND.removeChannel(t)}},[e]),(0,a.useEffect)(()=>{p();let e=setInterval(p,3e5);return()=>clearInterval(e)},[]);let h=async()=>{try{if(!e)return[];let{data:r,error:t}=await o.ND.from("tickets").select("number").in("status",["vendido","reservado"]);if(t)return console.error("Error al obtener tickets no disponibles:",t),[];let a=new Set(r?.map(e=>e.number)||[]),s=[];for(let e=1;e<=1e4;e++)a.has(e)||s.push(e);return s}catch(e){return console.error("Error en getRealAvailableTickets:",e),[]}};return{isConnected:e,loading:t,fomoPercentage:l,refreshData:p,getRealAvailableTickets:h}}}}]);