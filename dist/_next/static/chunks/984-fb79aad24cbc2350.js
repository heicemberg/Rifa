"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[984],{3609:(e,t,o)=>{o.r(t),o.d(t,{actualizarEstadoCompra:()=>v,asignarNumerosDisponibles:()=>k,getConnectionStatus:()=>T,getSupabaseClient:()=>g,guardarCompra:()=>f,inicializarTickets:()=>b,initializeSupabase:()=>m,obtenerCompras:()=>h,obtenerEstadisticasTickets:()=>w,obtenerMetadata:()=>A,resetSupabaseConnection:()=>E,subirCaptura:()=>C,supabase:()=>u,testSupabaseConnection:()=>S,verificarConexion:()=>p});var s=o(2354),n=o(7358);let r={ANON_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnbWZtbndieW5wcGR6a2h2cmloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4ODE4NzAsImV4cCI6MjA3MTQ1Nzg3MH0.MTNKqQCzmRETjULZ2PRx8mTK3hpR90tn6Pz36h1nMR4",URLS:{DIRECT:"https://ugmfmnwbynppdzkhvrih.supabase.co",POOLER_SESSION:"https://aws-0-us-east-1.pooler.supabase.com",POOLER_TRANSACTION:"https://aws-0-us-east-1.pooler.supabase.com"}};function a(){let e=!!("true"===n.env.NETLIFY||n.env.CONTEXT||n.env.NETLIFY_DEV||window.__NETLIFY__);return{isNetlify:e,hasIPv6Support:"onLine"in navigator,isBuildTime:!1,context:n.env.CONTEXT||"unknown"}}let l=null;function i(){if(l)return l;let e=a(),t=function(){let e=a();return(console.log("\uD83D\uDD0D Environment detection:",e),e.isNetlify)?console.log("\uD83C\uDF10 Using Supavisor Pooler (IPv4) for Netlify compatibility"):console.log("\uD83C\uDF10 Using Direct Connection for local/other environments"),r.URLS.DIRECT}(),o=r.ANON_KEY,n={auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!1,flowType:"pkce"},realtime:{params:{eventsPerSecond:e.isNetlify?1:2}},global:{headers:{"X-Client-Info":"rifa-silverado-netlify@1.0.0","User-Agent":"RifaApp-Netlify/1.0",...e.isNetlify&&{"X-Netlify-Context":e.context,"X-IPv4-Required":"true","X-Pooler-Mode":"session"}},fetch:e.isNetlify?async(e,t)=>{let o=new AbortController,s=setTimeout(()=>o.abort(),6e4);try{let s=await fetch(e,{...t,signal:o.signal,headers:{...t?.headers,Connection:"keep-alive","Cache-Control":"no-cache","Accept-Encoding":"gzip, deflate, br",Accept:"application/json, text/plain, */*"}}),n="string"==typeof e?e:e instanceof URL?e.toString():"request";return console.log(`üì° Supabase request: ${n.substring(0,50)}... ‚Üí ${s.status}`),s}catch(e){throw console.error("‚ùå Netlify Supabase request failed:",e),e}finally{clearTimeout(s)}}:void 0}};return console.log("\uD83D\uDE80 Creating Netlify-compatible Supabase client:",{url:t.substring(0,40)+"...",environment:e,config:"netlify-optimized"}),l=(0,s.UU)(t,o,n)}async function c(){try{let e=i(),t=a();console.log("\uD83E\uDDEA Testing Netlify Supabase connection...");let o=Date.now(),{data:s,error:n}=await e.from("customers").select("count",{count:"exact",head:!0}).limit(1),r=Date.now()-o;if(n){console.error("‚ùå Netlify connection test failed:",n);let e=n.message;return n.message.includes("ENOTFOUND")||n.message.includes("getaddrinfo")?e=`DNS resolution failed - probablemente IPv6 incompatibility en Netlify. Error original: ${n.message}`:n.message.includes("timeout")?e=`Connection timeout en Netlify (${r}ms). Prueba usar Supavisor Pooler.`:n.message.includes("ECONNREFUSED")&&(e="Connection refused - IPv6 address not reachable from Netlify."),{success:!1,error:e,details:{originalError:n.message,environment:t,duration:r,suggestedSolution:"Use IPv4 Supavisor Pooler instead of Direct Connection"}}}return console.log(`‚úÖ Netlify Supabase connection successful (${r}ms)`),{success:!0,details:{environment:t,duration:r,connectionType:t.isNetlify?"ipv4-pooler":"direct"}}}catch(e){return console.error("‚ùå Critical Netlify connection error:",e),{success:!1,error:`Critical error: ${e instanceof Error?e.message:"Unknown error"}`,details:{error:e}}}}let d=i(),u=d,g=()=>d,m=async()=>(await c()).success,T=()=>({hasInstance:!0,attempts:0,url:"netlify-compatible",environment:"netlify-compatible",ready:!0}),S=c,E=function(){console.log("\uD83D\uDD04 Resetting Netlify Supabase client..."),l=null};async function p(){try{let{data:e,error:t}=await u.from("customers").select("count",{count:"exact",head:!0});if(t){if(console.error("‚ùå Error de conexi\xf3n Supabase:",t.message),t.message.includes("database is paused")||t.message.includes("project is paused")||t.message.includes("timeout"))throw console.error("\uD83D\uDEA8 Base de datos pausada. Revisa tu plan de Supabase."),Error("Base de datos pausada. Contacta al administrador o actualiza el plan.");return!1}return console.log("‚úÖ Conexi\xf3n Supabase exitosa"),!0}catch(e){return console.error("‚ùå Error cr\xedtico de conexi\xf3n:",e),!1}}async function f(e){try{if(console.log("\uD83D\uDCBE SUPABASE: Iniciando guardado de compra:",{nombre:e.nombre,boletos:e.cantidad_boletos,numeros:e.numeros_boletos?.length||0}),!await p())throw Error("No se pudo establecer conexi\xf3n con la base de datos. Intenta m\xe1s tarde.");console.log("\uD83D\uDC64 SUPABASE: Creando cliente...");let{data:t,error:o}=await u.from("customers").insert([{name:`${e.nombre} ${e.apellidos}`.trim(),email:e.email||"",phone:e.telefono||"",city:e.ciudad||"",state:e.estado||""}]).select().single();if(o)throw console.error("‚ùå SUPABASE: Error al crear cliente:",o),Error(`Error al crear cliente: ${o.message}`);console.log("‚úÖ SUPABASE: Cliente creado:",t.id),console.log("\uD83D\uDCB0 SUPABASE: Creando compra...");let{data:s,error:n}=await u.from("purchases").insert([{customer_id:t.id,total_amount:e.precio_total,unit_price:e.precio_unitario,discount_applied:e.descuento_aplicado||0,payment_method:e.metodo_pago,payment_reference:e.referencia_pago,payment_proof_url:e.captura_comprobante_url,browser_info:e.navegador||"unknown",device_info:e.dispositivo||"unknown",ip_address:e.ip_address||"unknown",user_agent:e.user_agent||"unknown",status:"pendiente"}]).select().single();if(n)throw console.error("‚ùå SUPABASE: Error al crear compra:",n),Error(`Error al crear compra: ${n.message}`);console.log("‚úÖ SUPABASE: Compra creada:",s.id);let r=[];if(e.numeros_boletos&&e.numeros_boletos.length>0){console.log("\uD83C\uDFAB SUPABASE: Reservando tickets espec\xedficos:",e.numeros_boletos);try{let{data:o,error:n}=await u.from("tickets").select("number, status").in("number",e.numeros_boletos);if(n)throw console.error("‚ùå SUPABASE: Error verificando tickets:",n),n;let a=o?.filter(e=>"disponible"!==e.status)||[];if(a.length>0)console.warn("‚ö†Ô∏è SUPABASE: Algunos tickets ya no est\xe1n disponibles:",a.map(e=>e.number)),console.log("\uD83D\uDD04 SUPABASE: Intentando asignaci\xf3n autom\xe1tica de tickets..."),r=await k(s.id,t.id,e.cantidad_boletos);else{let o=new Date().toISOString(),{data:n,error:a}=await u.from("tickets").update({status:"reservado",customer_id:t.id,purchase_id:s.id,reserved_at:o}).in("number",e.numeros_boletos).eq("status","disponible").select();if(a)throw console.error("‚ùå SUPABASE: Error reservando tickets:",a),a;r=n||[],console.log(`‚úÖ SUPABASE: ${r.length} tickets reservados exitosamente`),setTimeout(()=>{window.dispatchEvent(new CustomEvent("raffle-counters-updated",{detail:{source:"ticket-reservation",reservedTickets:r.length,timestamp:new Date().toISOString()}}))},100)}}catch(o){console.error("‚ùå SUPABASE: Error manejando tickets espec\xedficos:",o),console.log("\uD83D\uDD04 SUPABASE: Fallback - asignaci\xf3n autom\xe1tica...");try{r=await k(s.id,t.id,e.cantidad_boletos)}catch(e){console.error("‚ùå SUPABASE: Error en asignaci\xf3n de fallback:",e),console.warn("‚ö†Ô∏è SUPABASE: Compra creada sin tickets asignados - se asignar\xe1n en confirmaci\xf3n admin")}}}else console.log("\uD83D\uDCDD SUPABASE: Compra creada sin tickets espec\xedficos - se asignar\xe1n al confirmar");let a={customer:t,purchase:s,tickets:r};return console.log("‚úÖ SUPABASE: Compra guardada exitosamente:",{customerId:t.id,purchaseId:s.id,ticketsCount:r.length}),a}catch(e){if(console.error("‚ùå SUPABASE: Error completo en guardarCompra:",e),e instanceof Error){if(e.message.includes("duplicate key"))throw Error("Error: datos duplicados detectados. Intenta de nuevo.");else if(e.message.includes("network")||e.message.includes("timeout"))throw Error("Error de conexi\xf3n. Verifica tu internet e intenta de nuevo.");else if(e.message.includes("authentication"))throw Error("Error de autenticaci\xf3n con la base de datos. Contacta soporte.")}throw e}}function A(){return{navegador:navigator.userAgent,dispositivo:/Mobi|Android/i.test(navigator.userAgent)?"m\xf3vil":"escritorio",user_agent:navigator.userAgent,timestamp:new Date().toISOString(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,idioma:navigator.language,pantalla:`${screen.width}x${screen.height}`}}async function C(e,t){try{let o=new Date().getTime(),s=e.name.split(".").pop(),n=`capturas/${t.replace(/\s+/g,"_")}_${o}.${s}`,{data:r,error:a}=await u.storage.from("comprobantes").upload(n,e);if(a)throw console.error("‚ùå Error al subir archivo:",a),a;let{data:l}=u.storage.from("comprobantes").getPublicUrl(n);return console.log("‚úÖ Archivo subido exitosamente"),l.publicUrl}catch(e){return console.error("‚ùå Error en subirCaptura:",e),null}}async function h(){try{let{data:e,error:t}=await u.from("purchases").select(`
        *,
        customer:customers(*),
        tickets(*)
      `).order("created_at",{ascending:!1});if(t)throw console.error("‚ùå Error al obtener compras:",t),t;return e}catch(e){throw console.error("‚ùå Error en obtenerCompras:",e),e}}async function v(e,t,o,s){try{console.log(`üîÑ Actualizando compra ${e} a estado: ${t}`);let{data:n,error:r}=await u.from("purchases").select(`
        *,
        customer:customers(*),
        tickets(*)
      `).eq("id",e).single();if(r)throw r;let a={status:t,notes:o,verified_by:s};"confirmada"===t&&(a.verified_at=new Date().toISOString());let{data:l,error:i}=await u.from("purchases").update(a).eq("id",e).select().single();if(i)throw i;let c=[];if("confirmada"===t){let t=Math.round(l.total_amount/l.unit_price);if(n.tickets&&0!==n.tickets.length)console.log(`‚ÑπÔ∏è La compra ya tiene ${n.tickets.length} tickets asignados`),c=n.tickets;else try{c=await k(e,l.customer_id,t),console.log(`‚úÖ Compra confirmada y ${c.length} tickets asignados`)}catch(t){throw console.error("‚ùå Error al asignar tickets:",t),await u.from("purchases").update({status:"pendiente"}).eq("id",e),Error(`No se pudo confirmar: ${t instanceof Error?t.message:"Error al asignar tickets"}`)}}if("cancelada"===t){let{error:t}=await u.from("tickets").update({status:"disponible",customer_id:null,purchase_id:null,sold_at:null,reserved_at:null}).eq("purchase_id",e);t?console.error("‚ùå Error al liberar tickets:",t):console.log("\uD83D\uDD04 Tickets liberados por cancelaci\xf3n")}let{data:d,error:g}=await u.from("purchases").select(`
        *,
        customer:customers(*),
        tickets(*)
      `).eq("id",e).single();if(g)throw g;return console.log("‚úÖ Compra actualizada correctamente"),d}catch(e){throw console.error("‚ùå Error en actualizarEstadoCompra:",e),e}}async function k(e,t,o){try{console.log(`üé´ Intentando asignar ${o} tickets para compra ${e}`);let{data:s,error:n}=await u.from("tickets").select("*").eq("status","disponible").order("number").limit(o);if(n)throw n;if(!s||s.length<o){let e=s?.length||0;throw Error(`Insuficientes tickets disponibles. Solo hay ${e}, necesitas ${o}`)}let r=s.map(e=>e.number),a=new Date().toISOString(),{data:l,error:i}=await u.from("tickets").update({status:"vendido",customer_id:t,purchase_id:e,sold_at:a}).in("number",r).select();if(i)throw i;return console.log(`‚úÖ Asignados ${l?.length} tickets:`,r),console.log(`üîî SUPABASE: Disparando evento de sincronizaci\xf3n post-asignaci\xf3n...`),setTimeout(()=>{window.dispatchEvent(new CustomEvent("raffle-counters-updated",{detail:{source:"ticket-assignment",assignedTickets:l?.length||0,timestamp:new Date().toISOString()}}))},100),l||[]}catch(e){throw console.error("‚ùå Error al asignar n\xfameros:",e),e}}async function b(){try{console.log("\uD83D\uDE80 Inicializando base de datos de tickets...");let{count:e,error:t}=await u.from("tickets").select("*",{count:"exact",head:!0});if(t)throw t;if(e&&e>0)return console.log(`‚ÑπÔ∏è Ya existen ${e} tickets en la base de datos`),!0;let o=[];for(let e=1;e<=1e4;e++)o.push({number:e,status:"disponible"});console.log("\uD83D\uDCDD Insertando 10,000 tickets...");for(let e=0;e<o.length;e+=1e3){let t=o.slice(e,e+1e3),{error:s}=await u.from("tickets").insert(t);if(s)throw console.error(`‚ùå Error insertando lote ${e/1e3+1}:`,s),s;console.log(`‚úÖ Lote ${e/1e3+1}/${Math.ceil(o.length/1e3)} insertado`)}return console.log("‚úÖ Base de datos de tickets inicializada correctamente"),!0}catch(e){return console.error("‚ùå Error al inicializar tickets:",e),!1}}async function w(){try{let{data:e,error:t}=await u.from("tickets").select("status").then(e=>{let{data:t,error:o}=e;return o?{data:null,error:o}:{data:{total:t?.length||0,disponibles:t?.filter(e=>"disponible"===e.status).length||0,vendidos:t?.filter(e=>"vendido"===e.status).length||0,reservados:t?.filter(e=>"reservado"===e.status).length||0},error:null}});if(t)throw t;return e}catch(e){return console.error("‚ùå Error al obtener estad\xedsticas:",e),null}}},4984:(e,t,o)=>{o.d(t,{By:()=>p,J5:()=>S,N_:()=>f,ht:()=>T,ib:()=>E,zC:()=>A});var s=o(2115),n=o(3609),r=o(1530);let a=null,l=new Set,i=null,c=null,d=null,u=async()=>{try{if(!n.supabase)throw Error("Supabase no inicializado");console.log("\uD83D\uDD0D FETCHING REAL DATA: Querying tickets table...");let{data:e,error:t}=await n.supabase.from("tickets").select("status").in("status",["vendido","reservado"]);if(t)throw console.error("\uD83D\uDD34 Supabase query error:",t),t;let o=e?.filter(e=>"vendido"===e.status).length||0,s=e?.filter(e=>"reservado"===e.status).length||0;return console.log(`üìä REAL DATA FETCHED: ${o} sold, ${s} reserved from ${e?.length||0} total records`),o+s>1e4&&console.error(`üö® DATA INTEGRITY ERROR: sold + reserved (${o+s}) > total tickets (10000)`),{sold:o,reserved:s}}catch(e){return console.error("\uD83D\uDD34 Error fetching real data:",e),console.error("\uD83D\uDD27 FALLBACK: Using zero values for sold and reserved"),{sold:0,reserved:0}}},g=async function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0];try{console.log("\uD83D\uDD04 UPDATING MASTER COUNTERS...");let{sold:e,reserved:t}=await u(),s=1e4-e-t;console.log(`üßÆ CALCULATING: ${e} sold + ${t} reserved = ${e+t} occupied`),console.log(`üéØ AVAILABLE CALCULATION: 10000 total - ${e+t} occupied = ${s} available`);let i=e+s+t;if(1e4!==i){if(console.error(`üö® CRITICAL MATH ERROR: ${e}S + ${s}A + ${t}R = ${i} ‚â† 10000`),console.error("\uD83D\uDD27 This indicates a data synchronization problem with Supabase"),r.default.error(`Error matem\xe1tico cr\xedtico: ${i} ‚â† 10000. Revisar sincronizaci\xf3n BD.`),5>=Math.abs(i-1e4)){console.warn("\uD83D\uDD27 ATTEMPTING AUTO-CORRECTION: Minor math discrepancy, adjusting available count");let o=1e4-e-t;console.warn(`üîß CORRECTED: available ${s} ‚Üí ${o}`)}}else console.log(`‚úÖ MATH CHECK PASSED: ${e} + ${s} + ${t} = ${i} = 10000`);try{{console.log("\uD83D\uDCCA FETCHING SPECIFIC TICKET NUMBERS FOR ZUSTAND SYNC...");let{data:e,error:t}=await n.supabase.from("tickets").select("number, status").in("status",["vendido","reservado"]);if(!t&&e){let t=e.filter(e=>"vendido"===e.status).map(e=>e.number),s=e.filter(e=>"reservado"===e.status).map(e=>e.number);console.log(`üîÑ SYNCING ZUSTAND STORE: ${t.length} sold, ${s.length} reserved`);let n=window.__ZUSTAND_RAFFLE_STORE__;if(n&&n.getState){let e=n.getState();console.log("\uD83D\uDD04 FORCE UPDATING ZUSTAND STORE:",{soldTickets:t.length,reservedTickets:s.length}),e.setSoldTicketsFromDB(t),e.setReservedTicketsFromDB(s),console.log("‚úÖ ZUSTAND STORE FORCE UPDATED")}else console.warn("‚ö†Ô∏è Zustand store not found in window, attempting dynamic import sync..."),Promise.all([o.e(690),o.e(726)]).then(o.bind(o,5726)).then(e=>{let{useRaffleStore:o}=e,n=o.getState();console.log("\uD83D\uDD04 DYNAMIC IMPORT: Force updating Zustand via fallback"),n.setSoldTicketsFromDB(t),n.setReservedTicketsFromDB(s),console.log("‚úÖ ZUSTAND SYNC via dynamic import completed")}).catch(e=>{console.error("‚ùå Failed to sync with Zustand store via dynamic import:",e)})}else console.error("‚ùå Failed to fetch ticket numbers for Zustand sync:",t)}}catch(e){console.error("‚ùå Error syncing with Zustand store:",e)}let{fomoCount:c,isActive:g}=(e=>{if(e/1e4*100>=18)return{fomoCount:e,isActive:!1};d||(d=parseInt(localStorage.getItem("fomo_session_start")||Date.now().toString()),localStorage.setItem("fomo_session_start",d.toString()));let t=(Date.now()-d)/6e4,o=Math.floor(Math.min(12,8+.05*Math.floor(t/2))/100*1e4),s=o+e;return e>0&&console.log(`üéØ SUMA ORG\xc1NICA: Base(${o}) + Real(${e}) = Display(${s})`),{fomoCount:s,isActive:!0}})(e),m={totalTickets:1e4,soldTickets:e,reservedTickets:t,availableTickets:s,fomoSoldTickets:c,fomoIsActive:g,soldPercentage:e/1e4*100,fomoPercentage:c/1e4*100,availablePercentage:s/1e4*100,isConnected:!0,lastUpdate:new Date,isLoading:!1};return console.log(`üìä CONTADOR ACTUALIZADO: ${c} vendidos (${m.fomoPercentage.toFixed(1)}%), ${s} disponibles`),a=m,console.log(`üîî NOTIFYING ${l.size} listeners...`),l.forEach(e=>e(m)),m}catch(t){console.error("\uD83D\uDD34 Error updating master counters:",t);let e={totalTickets:1e4,soldTickets:0,reservedTickets:0,availableTickets:1e4,fomoSoldTickets:Math.floor(800),fomoIsActive:!0,soldPercentage:0,fomoPercentage:8,availablePercentage:100,isConnected:!1,lastUpdate:new Date,isLoading:!1};return a=e,l.forEach(t=>t(e)),e}},m=async()=>a?a:(a={totalTickets:1e4,soldTickets:0,reservedTickets:0,availableTickets:1e4,fomoSoldTickets:Math.floor(800),fomoIsActive:!0,soldPercentage:0,fomoPercentage:8,availablePercentage:100,isConnected:!1,lastUpdate:new Date,isLoading:!0},n.supabase&&!c&&(console.log("\uD83D\uDD0C SETTING UP WEBSOCKET SUBSCRIPTIONS..."),c=n.supabase.channel("master_counters").on("postgres_changes",{event:"*",schema:"public",table:"tickets"},e=>{console.log("\uD83C\uDFAB TICKET CHANGE DETECTED:",e.eventType,e.new||e.old),console.log("\uD83D\uDD04 TRIGGERING IMMEDIATE COUNTER UPDATE (TICKETS)..."),setTimeout(()=>g(!0),100),window.dispatchEvent(new CustomEvent("ticket-status-changed",{detail:{source:"websocket",event:e.eventType,ticket:e.new||e.old,timestamp:new Date().toISOString()}}))}).on("postgres_changes",{event:"*",schema:"public",table:"purchases"},e=>{console.log("\uD83D\uDCB0 PURCHASE CHANGE DETECTED:",e.eventType,e.new||e.old),console.log("\uD83D\uDD04 TRIGGERING IMMEDIATE COUNTER UPDATE (PURCHASES)..."),setTimeout(()=>g(!0),100),setTimeout(()=>g(!0),1500),window.dispatchEvent(new CustomEvent("purchase-status-changed",{detail:{source:"websocket",event:e.eventType,purchase:e.new||e.old,timestamp:new Date().toISOString()}}))}).subscribe(e=>{console.log("\uD83D\uDCE1 WEBSOCKET SUBSCRIPTION STATUS:",e),"SUBSCRIBED"===e?(console.log("‚úÖ WEBSOCKET CONNECTED: Real-time updates active"),console.log("\uD83D\uDD0D WEBSOCKET: Testing connectivity...")):"CHANNEL_ERROR"===e?(console.error("\uD83D\uDD34 WEBSOCKET ERROR: Real-time updates may not work"),console.error("\uD83D\uDD27 FALLBACK: Will rely on interval updates")):"CLOSED"===e&&(console.warn("‚ö†Ô∏è WEBSOCKET CLOSED: Attempting to reconnect..."),setTimeout(()=>{console.log("\uD83D\uDD04 RECONNECTING WEBSOCKET..."),c=null,m()},3e3))})),window.__raffleSyncListenerSetup||(console.log("\uD83D\uDD14 SETTING UP GLOBAL SYNC EVENT LISTENER..."),window.addEventListener("raffle-counters-updated",e=>{console.log("\uD83D\uDD14 GLOBAL SYNC EVENT RECEIVED:",e.detail),console.log("\uD83D\uDD04 FORCING MASTER COUNTER UPDATE..."),g(!0)}),window.__raffleSyncListenerSetup=!0,window.addEventListener("focus",()=>{console.log("\uD83D\uDD0D WINDOW FOCUS: Refreshing counters..."),g(!0)})),i||(i=setInterval(()=>{console.log("‚è±Ô∏è INTERVAL: Triggering periodic counter update..."),g()},15e3)),await g(!0)),T=()=>{let[e,t]=(0,s.useState)(a||{totalTickets:1e4,soldTickets:0,reservedTickets:0,availableTickets:1e4,fomoSoldTickets:Math.floor(800),fomoIsActive:!0,soldPercentage:0,fomoPercentage:8,availablePercentage:100,isConnected:!1,lastUpdate:new Date,isLoading:!0});return(0,s.useEffect)(()=>{let e=e=>t(e);return l.add(e),(!a||a.isLoading)&&m(),()=>{l.delete(e)}},[]),e},S=()=>{let e=T(),t=e.fomoSoldTickets,o=e.availableTickets,s=e.soldTickets+o+e.reservedTickets;return s!==e.totalTickets?(console.error(`üö® CRITICAL MATH ERROR: ${e.soldTickets}S + ${o}A + ${e.reservedTickets}R = ${s} ‚â† ${e.totalTickets}`),console.error(`üîß FORCING CORRECTION TO MAINTAIN MATHEMATICAL INTEGRITY`)):.05>Math.random()&&(console.log(`‚úÖ MATH VERIFIED: ${e.soldTickets}S + ${o}A + ${e.reservedTickets}R = ${s} = ${e.totalTickets}`),console.log(`üìä DISPLAY: Real ${e.soldTickets} ‚Üí Display ${t} (Base FOMO + ${e.soldTickets} ventas reales)`),console.log(`üéØ AVAILABLE: ${o} (always real data for mathematical accuracy)`)),{totalTickets:e.totalTickets,soldTickets:t,availableTickets:o,soldPercentage:e.fomoPercentage,isConnected:e.isConnected,lastUpdate:e.lastUpdate}},E=()=>{let e=T();return{display:{soldTickets:e.fomoSoldTickets,soldPercentage:e.fomoPercentage,availableTickets:e.availableTickets},real:{soldTickets:e.soldTickets,soldPercentage:e.soldPercentage,availableTickets:e.availableTickets,reservedTickets:e.reservedTickets},fomo:{isActive:e.fomoIsActive,difference:e.fomoSoldTickets-e.soldTickets},meta:{isConnected:e.isConnected,lastUpdate:e.lastUpdate,totalTickets:e.totalTickets}}},p=()=>{let e=T(),t=e.fomoSoldTickets,o=e.availableTickets,s=e.soldTickets+o+e.reservedTickets;return s!==e.totalTickets&&console.error(`üö® DISPLAY STATS MATH ERROR: ${e.soldTickets}S + ${o}A + ${e.reservedTickets}R = ${s} ‚â† ${e.totalTickets}`),{soldCount:t,availableCount:o,reservedCount:e.reservedTickets,totalCount:e.totalTickets,soldPercentage:e.fomoPercentage,realSoldCount:e.soldTickets,isConnected:e.isConnected,lastUpdate:e.lastUpdate}},f=()=>{if(!a)return console.error("\uD83D\uDEA8 TEST FAILED: No master counter instance available"),!1;let{soldTickets:e,availableTickets:t,reservedTickets:o,totalTickets:s,fomoSoldTickets:n,fomoIsActive:r}=a;console.group("\uD83E\uDDEE MATH CONSISTENCY TEST");let l=e+t+o,i=l===s;console.log(`üìä REAL DATA TEST:`),console.log(`   Sold: ${e}`),console.log(`   Available: ${t}`),console.log(`   Reserved: ${o}`),console.log(`   Sum: ${l}`),console.log(`   Expected: ${s}`),console.log(`   Result: ${i?"‚úÖ PASS":"‚ùå FAIL"}`),console.log(`üé≠ FOMO DISPLAY TEST:`),console.log(`   Display Sold: ${n} (real: ${e})`),console.log(`   Display Available: ${t} (always real)`),console.log(`   FOMO Active: ${r}`),console.log(`   FOMO Difference: +${n-e} fake sold`);let c=s-e-o,d=t===c;console.log(`üéØ AVAILABLE CALCULATION TEST:`),console.log(`   Formula: ${s} - ${e} - ${o} = ${c}`),console.log(`   Actual Available: ${t}`),console.log(`   Result: ${d?"‚úÖ PASS":"‚ùå FAIL"}`);let u=i&&d;return console.log(`üîÑ OVERALL SYNC TEST:`),console.log(`   Real Math: ${i?"‚úÖ":"‚ùå"}`),console.log(`   Available Calc: ${d?"‚úÖ":"‚ùå"}`),console.log(`   Overall: ${u?"‚úÖ SYSTEM SYNCHRONIZED":"‚ùå SYNC ISSUES DETECTED"}`),console.groupEnd(),u||console.error("\uD83D\uDEA8 CRITICAL: Counter synchronization issues detected. Tickets available may not decrease when sold."),u},A=()=>(console.log("\uD83D\uDD04 FORCING MASTER COUNTER UPDATE..."),g(!0));window.raffleCounterTest={testMath:f,forceUpdate:A,getCounters:()=>a,getListeners:()=>l.size,runFullTest:()=>{console.log("\uD83E\uDDEA RUNNING FULL COUNTER TEST...");let e=f();return console.log(`üìä Current listeners: ${l.size}`),console.log(`üîó Connected: ${a?.isConnected||"unknown"}`),console.log(`‚è∞ Last update: ${a?.lastUpdate?.toLocaleTimeString()||"never"}`),e},testAdminSync:async()=>{console.group("\uD83D\uDD04 TESTING ADMIN SYNC FLOW...");try{console.log("1Ô∏è‚É£ Testing current system state...");let e=f();console.log("2Ô∏è‚É£ Testing WebSocket connectivity...");let t=null!==c;console.log(`   WebSocket: ${t?"‚úÖ Connected":"‚ùå Not connected"}`),console.log("3Ô∏è‚É£ Testing Zustand store exposure...");let o=window.__ZUSTAND_RAFFLE_STORE__,s=!!(o&&o.getState);console.log(`   Zustand Store: ${s?"‚úÖ Available":"‚ùå Not available"}`),console.log("4Ô∏è‚É£ Testing Master Counter sync...");let n=a?.soldTickets||0;await A();let r=a?.soldTickets||0;console.log(`   Master Counter Update: ${n} ‚Üí ${r} ${n!==r?"‚úÖ Changed":"‚ö†Ô∏è No change"}`),console.log("5Ô∏è‚É£ Testing event system...");let l=!1,i=()=>{l=!0};window.addEventListener("raffle-counters-updated",i),window.dispatchEvent(new CustomEvent("raffle-counters-updated",{detail:{source:"sync-test",timestamp:new Date().toISOString()}})),setTimeout(()=>{window.removeEventListener("raffle-counters-updated",i),console.log(`   Event System: ${l?"‚úÖ Working":"‚ùå Not working"}`),console.log("6Ô∏è‚É£ Final Assessment...");let o=e&&t&&s&&l;return console.log(`
üéØ ADMIN SYNC TEST RESULTS:
   Math Consistency: ${e?"‚úÖ":"‚ùå"}
   WebSocket: ${t?"‚úÖ":"‚ùå"}
   Zustand Store: ${s?"‚úÖ":"‚ùå"}
   Event System: ${l?"‚úÖ":"‚ùå"}
   
üîÑ OVERALL: ${o?"‚úÖ READY FOR ADMIN SYNC":"‚ùå SYNC ISSUES DETECTED"}

üí° USAGE: When admin confirms a purchase, all components should update within 2-3 seconds.
          `),console.groupEnd(),{success:o,components:{mathTest:e,wsConnected:t,zustandAvailable:s,eventReceived:l}}},100)}catch(e){return console.error("‚ùå Admin sync test failed:",e),console.groupEnd(),{success:!1,error:e instanceof Error?e.message:String(e)}}},testFullSync:async()=>{console.group("\uD83D\uDD04 TESTING COMPLETE SYNCHRONIZATION...");try{console.log("1Ô∏è‚É£ Testing Master Counter...");let e=f();console.log(`   Math Test: ${e?"‚úÖ PASS":"‚ùå FAIL"}`),console.log("2Ô∏è‚É£ Testing Zustand Store Connection...");let t=window.__ZUSTAND_RAFFLE_STORE__,o=!!(t&&t.getState);if(console.log(`   Zustand Connected: ${o?"‚úÖ PASS":"‚ùå FAIL"}`),o){let e=t.getState();console.log(`   Zustand Sold Tickets: ${e.soldTickets.length}`),console.log(`   Zustand Reserved Tickets: ${e.reservedTickets.length}`)}console.log("3Ô∏è‚É£ Testing Supabase Connection...");let s=a?.isConnected||!1;console.log(`   Supabase Connected: ${s?"‚úÖ PASS":"‚ùå FAIL"}`),s&&(console.log(`   Master Sold: ${a?.soldTickets||0}`),console.log(`   Master Available: ${a?.availableTickets||0}`),console.log(`   Master Reserved: ${a?.reservedTickets||0}`)),console.log("4Ô∏è‚É£ Testing Force Sync..."),await A(),console.log("   Force Update: ‚úÖ COMPLETED"),console.log("5Ô∏è‚É£ Testing WebSocket Status...");let n=null!==c;console.log(`   WebSocket Connected: ${n?"‚úÖ PASS":"‚ùå FAIL"}`),console.log("6Ô∏è‚É£ Testing Data Consistency...");let r=!0;if(o&&s){let e=t.getState(),o=a?.soldTickets||0,s=e.soldTickets.length;Math.abs(o-s)>5?(console.error(`   ‚ùå INCONSISTENCY: Master (${o}) vs Zustand (${s})`),r=!1):console.log(`   ‚úÖ CONSISTENT: Master (${o}) ‚âà Zustand (${s})`)}console.log("7Ô∏è‚É£ Final Assessment...");let l=e&&o&&s&&r;return console.log(`
üîç SYNC TEST RESULTS:
   Math Consistency: ${e?"‚úÖ":"‚ùå"}
   Zustand Connection: ${o?"‚úÖ":"‚ùå"}
   Supabase Connection: ${s?"‚úÖ":"‚ùå"}  
   WebSocket Status: ${n?"‚úÖ":"‚ùå"}
   Data Consistency: ${r?"‚úÖ":"‚ùå"}
   
üéØ OVERALL SYNC: ${l?"‚úÖ WORKING CORRECTLY":"‚ùå ISSUES DETECTED"}
        `),{success:l,details:{mathTest:e,zustandConnected:o,masterConnected:s,wsConnected:n,consistencyTest:r}}}catch(e){return console.error("‚ùå Sync test failed:",e),{success:!1,error:e instanceof Error?e.message:String(e)}}finally{console.groupEnd()}}}}}]);