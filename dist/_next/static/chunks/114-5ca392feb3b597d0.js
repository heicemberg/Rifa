"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[114],{2099:(e,t,r)=>{r.d(t,{AG:()=>s,HF:()=>i,LC:()=>l,ND:()=>a,aE:()=>m,bf:()=>d,jB:()=>n,ru:()=>u,t1:()=>f,x$:()=>p,zk:()=>c});var o=r(7965);let a=o.LY,s=()=>o.LY,n=async()=>(await (0,o.wT)()).success,i=()=>({hasInstance:!0,attempts:0,url:"netlify-compatible",environment:"netlify-compatible",ready:!0}),l=o.wT;async function c(){try{let{data:e,error:t}=await a.from("customers").select("count",{count:"exact",head:!0});if(t){if(console.error("‚ùå Error de conexi\xf3n Supabase:",t.message),t.message.includes("database is paused")||t.message.includes("project is paused")||t.message.includes("timeout"))throw console.error("\uD83D\uDEA8 Base de datos pausada. Revisa tu plan de Supabase."),Error("Base de datos pausada. Contacta al administrador o actualiza el plan.");return!1}return console.log("‚úÖ Conexi\xf3n Supabase exitosa"),!0}catch(e){return console.error("‚ùå Error cr\xedtico de conexi\xf3n:",e),!1}}async function u(e){try{if(!await c())throw Error("No se pudo establecer conexi\xf3n con la base de datos. Intenta m\xe1s tarde.");console.log("\uD83D\uDCBE Guardando compra:",e);let{data:t,error:r}=await a.from("customers").insert([{name:`${e.nombre} ${e.apellidos}`,email:e.email,phone:e.telefono,city:e.ciudad,state:e.estado}]).select().single();if(r)throw console.error("‚ùå Error al crear cliente:",r),Error(`Error al crear cliente: ${r.message}`);let{data:o,error:s}=await a.from("purchases").insert([{customer_id:t.id,total_amount:e.precio_total,unit_price:e.precio_unitario,discount_applied:e.descuento_aplicado||0,payment_method:e.metodo_pago,payment_reference:e.referencia_pago,payment_proof_url:e.captura_comprobante_url,browser_info:e.navegador,device_info:e.dispositivo,ip_address:e.ip_address,user_agent:e.user_agent,status:"pendiente"}]).select().single();if(s)throw console.error("‚ùå Error al crear compra:",s),Error(`Error al crear compra: ${s.message}`);return console.log("‚úÖ Compra guardada exitosamente"),{customer:t,purchase:o,tickets:[]}}catch(e){throw console.error("‚ùå Error completo en guardarCompra:",e),e}}function d(){return{navegador:navigator.userAgent,dispositivo:/Mobi|Android/i.test(navigator.userAgent)?"m\xf3vil":"escritorio",user_agent:navigator.userAgent,timestamp:new Date().toISOString(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,idioma:navigator.language,pantalla:`${screen.width}x${screen.height}`}}async function m(e,t){try{let r=new Date().getTime(),o=e.name.split(".").pop(),s=`capturas/${t.replace(/\s+/g,"_")}_${r}.${o}`,{data:n,error:i}=await a.storage.from("comprobantes").upload(s,e);if(i)throw console.error("‚ùå Error al subir archivo:",i),i;let{data:l}=a.storage.from("comprobantes").getPublicUrl(s);return console.log("‚úÖ Archivo subido exitosamente"),l.publicUrl}catch(e){return console.error("‚ùå Error en subirCaptura:",e),null}}async function p(){try{let{data:e,error:t}=await a.from("purchases").select(`
        *,
        customer:customers(*),
        tickets(*)
      `).order("created_at",{ascending:!1});if(t)throw console.error("‚ùå Error al obtener compras:",t),t;return e}catch(e){throw console.error("‚ùå Error en obtenerCompras:",e),e}}async function f(e,t,r,o){try{let{data:s,error:n}=await a.from("purchases").select(`
        *,
        customer:customers(*)
      `).eq("id",e).single();if(n)throw n;let i={status:t,notes:r,verified_by:o};"confirmada"===t&&(i.verified_at=new Date().toISOString());let{data:l,error:c}=await a.from("purchases").update(i).eq("id",e).select().single();if(c)throw c;let u=[];if("confirmada"===t){let t=Math.round(l.total_amount/l.unit_price);try{u=await g(e,l.customer_id,t),console.log(`‚úÖ Compra confirmada y ${u.length} tickets asignados`)}catch(t){throw console.error("‚ùå Error al asignar tickets:",t),await a.from("purchases").update({status:"pendiente"}).eq("id",e),Error(`No se pudo confirmar: ${t instanceof Error?t.message:"Error al asignar tickets"}`)}}"cancelada"===t&&(await a.from("tickets").update({status:"disponible",customer_id:null,purchase_id:null,sold_at:null}).eq("purchase_id",e),console.log("\uD83D\uDD04 Tickets liberados por cancelaci\xf3n"));let{data:d,error:m}=await a.from("purchases").select(`
        *,
        customer:customers(*),
        tickets(*)
      `).eq("id",e).single();if(m)throw m;return console.log("‚úÖ Compra actualizada"),d}catch(e){throw console.error("‚ùå Error en actualizarEstadoCompra:",e),e}}async function g(e,t,r){try{let{data:o,error:s}=await a.from("tickets").select("*").eq("status","disponible").order("number").limit(r);if(s)throw s;if(!o||o.length<r)throw Error(`Solo hay ${o?.length||0} tickets disponibles, necesitas ${r}`);let n=o.map(e=>e.number),i=new Date().toISOString(),{data:l,error:c}=await a.from("tickets").update({status:"vendido",customer_id:t,purchase_id:e,sold_at:i}).in("number",n).select();if(c)throw c;return console.log(`‚úÖ Asignados ${l?.length} tickets:`,n),l||[]}catch(e){throw console.error("‚ùå Error al asignar n\xfameros:",e),e}}},7965:(e,t,r)=>{r.d(t,{LY:()=>u,wT:()=>c});var o=r(2354),a=r(7358);let s={ANON_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnbWZtbndieW5wcGR6a2h2cmloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4ODE4NzAsImV4cCI6MjA3MTQ1Nzg3MH0.MTNKqQCzmRETjULZ2PRx8mTK3hpR90tn6Pz36h1nMR4",URLS:{DIRECT:"https://ugmfmnwbynppdzkhvrih.supabase.co",POOLER_SESSION:"https://aws-0-us-east-1.pooler.supabase.com",POOLER_TRANSACTION:"https://aws-0-us-east-1.pooler.supabase.com"}};function n(){let e=!!("true"===a.env.NETLIFY||a.env.CONTEXT||a.env.NETLIFY_DEV||window.__NETLIFY__);return{isNetlify:e,hasIPv6Support:"onLine"in navigator,isBuildTime:!1,context:a.env.CONTEXT||"unknown"}}let i=null;function l(){if(i)return i;let e=n(),t=function(){let e=n();return(console.log("\uD83D\uDD0D Environment detection:",e),e.isNetlify)?console.log("\uD83C\uDF10 Using Supavisor Pooler (IPv4) for Netlify compatibility"):console.log("\uD83C\uDF10 Using Direct Connection for local/other environments"),s.URLS.DIRECT}(),r=s.ANON_KEY,a={auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!1,flowType:"pkce"},realtime:{params:{eventsPerSecond:e.isNetlify?1:2}},global:{headers:{"X-Client-Info":"rifa-silverado-netlify@1.0.0","User-Agent":"RifaApp-Netlify/1.0",...e.isNetlify&&{"X-Netlify-Context":e.context,"X-IPv4-Required":"true","X-Pooler-Mode":"session"}},fetch:e.isNetlify?async(e,t)=>{let r=new AbortController,o=setTimeout(()=>r.abort(),6e4);try{let o=await fetch(e,{...t,signal:r.signal,headers:{...t?.headers,Connection:"keep-alive","Cache-Control":"no-cache","Accept-Encoding":"gzip, deflate, br",Accept:"application/json, text/plain, */*"}}),a="string"==typeof e?e:e instanceof URL?e.toString():"request";return console.log(`üì° Supabase request: ${a.substring(0,50)}... ‚Üí ${o.status}`),o}catch(e){throw console.error("‚ùå Netlify Supabase request failed:",e),e}finally{clearTimeout(o)}}:void 0}};return console.log("\uD83D\uDE80 Creating Netlify-compatible Supabase client:",{url:t.substring(0,40)+"...",environment:e,config:"netlify-optimized"}),i=(0,o.UU)(t,r,a)}async function c(){try{let e=l(),t=n();console.log("\uD83E\uDDEA Testing Netlify Supabase connection...");let r=Date.now(),{data:o,error:a}=await e.from("customers").select("count",{count:"exact",head:!0}).limit(1),s=Date.now()-r;if(a){console.error("‚ùå Netlify connection test failed:",a);let e=a.message;return a.message.includes("ENOTFOUND")||a.message.includes("getaddrinfo")?e=`DNS resolution failed - probablemente IPv6 incompatibility en Netlify. Error original: ${a.message}`:a.message.includes("timeout")?e=`Connection timeout en Netlify (${s}ms). Prueba usar Supavisor Pooler.`:a.message.includes("ECONNREFUSED")&&(e="Connection refused - IPv6 address not reachable from Netlify."),{success:!1,error:e,details:{originalError:a.message,environment:t,duration:s,suggestedSolution:"Use IPv4 Supavisor Pooler instead of Direct Connection"}}}return console.log(`‚úÖ Netlify Supabase connection successful (${s}ms)`),{success:!0,details:{environment:t,duration:s,connectionType:t.isNetlify?"ipv4-pooler":"direct"}}}catch(e){return console.error("‚ùå Critical Netlify connection error:",e),{success:!1,error:`Critical error: ${e instanceof Error?e.message:"Unknown error"}`,details:{error:e}}}}let u=l()},9114:(e,t,r)=>{r.d(t,{x:()=>i});var o=r(2115),a=r(2099),s=r(5726),n=r(1530);function i(){let[e,t]=(0,o.useState)(!1),[r,i]=(0,o.useState)(!0),[l,c]=(0,o.useState)(8),{_updateAvailableTickets:u,setSoldTicketsFromDB:d,setReservedTicketsFromDB:m}=(0,s.vW)(e=>({_updateAvailableTickets:e._updateAvailableTickets,setSoldTicketsFromDB:e.setSoldTicketsFromDB,setReservedTicketsFromDB:e.setReservedTicketsFromDB})),p=async()=>{try{i(!0);let e=await (0,a.zk)();if(t(e),!e){console.warn("Supabase no disponible, usando datos locales"),n.default.error("Base de datos no disponible, usando modo offline"),i(!1);return}let{data:r,error:o}=await a.ND.from("tickets").select("number").eq("status","vendido");if(o)console.error("Error al obtener tickets vendidos:",o),n.default.error("Error al cargar tickets vendidos");else{let e=r?.map(e=>e.number)||[],t=(e=>{if(e.length/1e4*100>=18)return e;let t=Math.max(0,Math.floor(l/100*1e4)-e.length);if(0===t)return e;let r=new Set(e),o=[];for(;o.length<t;){let e=Math.floor(1e4*Math.random())+1;r.has(e)||o.includes(e)||o.push(e)}let a=[...e,...o].sort((e,t)=>e-t);return console.log(`FOMO System: ${e.length} real + ${o.length} FOMO = ${a.length} total (${l}%)`),a})(e);d(t),console.log(`Cargados ${e.length} tickets reales, mostrando ${t.length} (${l}%)`)}let{data:s,error:c}=await a.ND.from("tickets").select("number").eq("status","reservado");if(c)console.error("Error al obtener tickets reservados:",c);else{let e=s?.map(e=>e.number)||[];m(e)}setTimeout(()=>{u()},100),n.default.success(`Datos sincronizados: ${l}% vendido`)}catch(e){console.error("Error al cargar datos iniciales:",e),n.default.error("Error al sincronizar con la base de datos"),t(!1)}finally{i(!1)}};(0,o.useEffect)(()=>{let e=setInterval(()=>{let e=Math.min(18,8+Math.min(2,Math.floor(Date.now()/18e5))+3*Math.random());Math.abs(e-l)>.5&&c(Math.floor(e))},12e4);return()=>clearInterval(e)},[l]),(0,o.useEffect)(()=>{if(!e)return;console.log("Configurando suscripciones en tiempo real...");let t=a.ND.channel("tickets-changes").on("postgres_changes",{event:"*",schema:"public",table:"tickets"},e=>{console.log("Cambio en tickets:",e),p()}).subscribe(),r=a.ND.channel("purchases-changes").on("postgres_changes",{event:"*",schema:"public",table:"purchases"},e=>{console.log("Cambio en compras:",e),"INSERT"===e.eventType&&n.default.success("\xa1Nueva compra registrada!",{duration:3e3,icon:"\uD83C\uDF89"})}).subscribe();return()=>{a.ND.removeChannel(t),a.ND.removeChannel(r)}},[e]),(0,o.useEffect)(()=>{p();let e=setInterval(p,3e5);return()=>clearInterval(e)},[]);let f=async()=>{try{if(!e)return[];let{data:t,error:r}=await a.ND.from("tickets").select("number").in("status",["vendido","reservado"]);if(r)return console.error("Error al obtener tickets no disponibles:",r),[];let o=new Set(t?.map(e=>e.number)||[]),s=[];for(let e=1;e<=1e4;e++)o.has(e)||s.push(e);return s}catch(e){return console.error("Error en getRealAvailableTickets:",e),[]}};return{isConnected:e,loading:r,fomoPercentage:l,refreshData:p,getRealAvailableTickets:f}}}}]);