"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[693],{2693:(e,t,o)=>{o.d(t,{By:()=>i,ib:()=>l});var a=o(2115),n=o(8091),r=o(5726);let s=()=>{let[e,t]=(0,a.useState)(0),[o,s]=(0,a.useState)(Date.now());(0,a.useEffect)(()=>{{let e=localStorage.getItem("rifa_session_start");s(e?parseInt(e):Date.now())}},[]);let{isConnected:i,realTicketsCount:l,lastSyncTime:c}=(0,n.x)(),{reservedTickets:u}=(0,r.vW)(e=>({reservedTickets:e.reservedTickets})),d=(0,a.useCallback)(()=>Math.floor(Math.min(16,Math.max(8,8+.5*Math.floor((Date.now()-o)/6e4/10)+(Math.random()-.5)*.6))/100*1e4),[o]);return(0,a.useEffect)(()=>{localStorage.getItem("rifa_session_start")||localStorage.setItem("rifa_session_start",o.toString());let e=()=>{t(d())};e();let a=setInterval(e,3e4);return()=>clearInterval(a)},[d,o]),(0,a.useMemo)(()=>{let t,o,a=u.length,n=1e4-l-a,r=l/1e4*100,s=r<18;return s&&i?o=(t=Math.max(l,e))/1e4*100:(t=l,o=r),{realSoldCount:l,realReservedCount:a,realAvailableCount:n,realSoldPercentage:r,displaySoldCount:t,displaySoldPercentage:o,displayAvailableCount:n,fomoBase:e,fomoIsActive:s,fomoIncrement:e,lastUpdate:c||new Date,isConnected:i,totalTickets:1e4}},[l,u.length,e,i,c])},i=()=>{let e=s();return{soldCount:e.displaySoldCount,soldPercentage:e.displaySoldPercentage,availableCount:e.displayAvailableCount,reservedCount:e.realReservedCount,totalCount:e.totalTickets,isConnected:e.isConnected,lastUpdate:e.lastUpdate}},l=()=>{let e=s();return{display:{soldCount:e.displaySoldCount,soldPercentage:e.displaySoldPercentage,availableCount:e.displayAvailableCount},real:{soldCount:e.realSoldCount,soldPercentage:e.realSoldPercentage,availableCount:e.realAvailableCount},fomo:{isActive:e.fomoIsActive,baseCount:e.fomoBase,increment:e.fomoIncrement},meta:{isConnected:e.isConnected,lastUpdate:e.lastUpdate,totalTickets:e.totalTickets}}}},8091:(e,t,o)=>{o.d(t,{x:()=>i});var a=o(2115),n=o(2099),r=o(5726),s=o(9940);function i(){let[e,t]=(0,a.useState)(!1),[o,i]=(0,a.useState)(!0),[l,c]=(0,a.useState)(0),[u,d]=(0,a.useState)(null),{visualPercentage:m,generateVisualTickets:p,isFomoActive:f}=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,[t,o]=(0,a.useState)(8),[n,r]=(0,a.useState)(800);return(0,a.useEffect)(()=>{let t=()=>{let t=e/1e4*100;if(t>=18){o(parseFloat(t.toFixed(1))),r(e);return}let a=Date.now(),n=a;n=parseInt(localStorage.getItem("rifa_session_start")||a.toString()),localStorage.getItem("rifa_session_start")||localStorage.setItem("rifa_session_start",a.toString());let s=Math.min(16,8+.5*Math.floor((a-n)/6e4/10)+(Math.random()-.5)*.3),i=Math.floor(s/100*1e4);o(parseFloat(s.toFixed(1))),r(i)};t();let a=setInterval(t,3e4);return()=>clearInterval(a)},[e]),{visualPercentage:t,visualTicketsCount:n,generateVisualTickets:t=>{if(e/1e4*100>=18||t.length>=n)return t;let o=new Set(t),a=[...t],r=n-t.length,s=new Date().toDateString(),i=0;for(let e=0;e<s.length;e++)i+=s.charCodeAt(e);let l=0;for(;a.length<n&&l<3*r;){let e=(i+1337*l)%1e4%1e4+1;o.has(e)||a.includes(e)||a.push(e),l++}return a.sort((e,t)=>e-t)},isFomoActive:()=>e/1e4*100<18}}(l),{_updateAvailableTickets:v,setSoldTicketsFromDB:g,setReservedTicketsFromDB:h}=(0,r.vW)(e=>({_updateAvailableTickets:e._updateAvailableTickets,setSoldTicketsFromDB:e.setSoldTicketsFromDB,setReservedTicketsFromDB:e.setReservedTicketsFromDB})),b=(0,a.useCallback)(async()=>{try{i(!0);let e=await (0,n.zk)();if(t(e),!e){console.warn("Supabase no disponible, usando datos locales"),s.xB.error("Base de datos no disponible, usando modo offline"),i(!1);return}let{data:o,error:a}=await n.ND.from("tickets").select("number, status").order("number");if(a){console.error("Error al obtener tickets:",a),s.xB.error("Error al cargar estado de tickets");return}let r=o?.filter(e=>"sold"===e.status).map(e=>e.number)||[],l=o?.filter(e=>"reserved"===e.status).map(e=>e.number)||[];c(r.length);let u=f()?p(r):r;g(u),h(l),d(new Date),setTimeout(()=>{v()},100)}catch(e){console.error("Error al cargar datos iniciales:",e),s.xB.error("Error al sincronizar con la base de datos"),t(!1)}finally{i(!1)}},[g,h,v]);(0,a.useEffect)(()=>{if(!e)return;console.log("\uD83D\uDD34 Configurando suscripciones en tiempo real...");let t=null,o=n.ND.channel("tickets-changes").on("postgres_changes",{event:"*",schema:"public",table:"tickets"},e=>{if(console.log("\uD83C\uDFAB Cambio en tickets:",e.eventType,e.new||e.old),t&&clearTimeout(t),t=setTimeout(()=>{b()},1e3),"UPDATE"===e.eventType){let t=e.new?.status,o=e.new?.number;"sold"===t?s.BJ.success(`\xa1Ticket ${String(o).padStart(4,"0")} vendido!`,{duration:2e3,icon:"\uD83C\uDFAF"}):"reserved"===t&&s.xB.info(`Ticket ${String(o).padStart(4,"0")} reservado`)}}).subscribe(),a=n.ND.channel("purchases-changes").on("postgres_changes",{event:"*",schema:"public",table:"purchases"},e=>{if(console.log("\uD83D\uDCB0 Cambio en compras:",e.eventType,e.new||e.old),"INSERT"===e.eventType){let t=e.new;s.BJ.success("\xa1Nueva compra registrada!",{duration:3e3,icon:"\uD83C\uDF89"}),s.xB.info(`Nueva compra: ${t?.payment_method||"N/A"} - $${t?.total_amount||0}`)}else if("UPDATE"===e.eventType){let t=e.new;t?.status==="completed"&&(s.BJ.success("\xa1Compra completada!",{duration:2e3,icon:"‚úÖ"}),setTimeout(()=>b(),1e3))}}).subscribe(),r=n.ND.channel("customers-changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"customers"},e=>{console.log("\uD83D\uDC64 Nuevo cliente:",e.new),s.xB.info(`Nuevo cliente: ${e.new?.name||"N/A"}`)}).subscribe();return()=>{t&&clearTimeout(t),n.ND.removeChannel(o),n.ND.removeChannel(a),n.ND.removeChannel(r)}},[e,b]),(0,a.useEffect)(()=>{b();let e=setInterval(b,3e5);return()=>clearInterval(e)},[]);let k=(0,a.useCallback)(async()=>{try{if(!e)return console.warn("No hay conexi\xf3n con Supabase, devolviendo array vac\xedo"),[];let{data:t,error:o}=await n.ND.from("tickets").select("number").in("status",["sold","reserved"]);if(o)return console.error("Error al obtener tickets no disponibles:",o),[];let a=new Set(t?.map(e=>e.number)||[]),r=[];for(let e=1;e<=1e4;e++)a.has(e)||r.push(e);return console.log(`üìä Tickets disponibles reales: ${r.length}`),r}catch(e){return console.error("Error en getRealAvailableTickets:",e),[]}},[e]),S=(0,a.useCallback)(async(t,o)=>{try{if(!e)return console.warn("No hay conexi\xf3n con Supabase, no se pueden reservar tickets"),!1;let{error:a}=await n.ND.from("tickets").update({status:"reserved",customer_id:o,reserved_at:new Date().toISOString()}).in("number",t).eq("status","available");if(a)return console.error("Error al reservar tickets:",a),!1;return console.log(`‚úÖ Reservados ${t.length} tickets en BD:`,t),s.xB.success(`Reservados ${t.length} tickets`),setTimeout(()=>b(),500),!0}catch(e){return console.error("Error en reserveTicketsInDB:",e),!1}},[e,b]),w=(0,a.useCallback)(async(t,o)=>{try{if(!e)return console.warn("No hay conexi\xf3n con Supabase, no se pueden marcar tickets como vendidos"),!1;let{error:a}=await n.ND.from("tickets").update({status:"sold",customer_id:o,sold_at:new Date().toISOString()}).in("number",t);if(a)return console.error("Error al marcar tickets como vendidos:",a),!1;return console.log(`‚úÖ Marcados ${t.length} tickets como vendidos:`,t),s.xB.success(`${t.length} tickets marcados como vendidos`),setTimeout(()=>b(),500),!0}catch(e){return console.error("Error en markTicketsAsSold:",e),!1}},[e,b]);return{isConnected:e,loading:o,realTicketsCount:l,visualPercentage:m,lastSyncTime:u,isFomoActive:f,refreshData:b,getRealAvailableTickets:k,reserveTicketsInDB:S,markTicketsAsSold:w}}},9940:(e,t,o)=>{o.d(t,{BJ:()=>r,xB:()=>n});var a=o(1530);let n={success:(e,t)=>{window.location.pathname.includes("/admin")&&a.default.success(`[ADMIN] ${e}`,{duration:t?.duration||4e3,icon:t?.icon||"\uD83D\uDD27",position:t?.position||"top-right"})},error:(e,t)=>{window.location.pathname.includes("/admin")&&a.default.error(`[ADMIN] ${e}`,{duration:t?.duration||5e3,icon:t?.icon||"‚ùå",position:t?.position||"top-right"})},loading:(e,t)=>window.location.pathname.includes("/admin")?a.default.loading(`[ADMIN] ${e}`,{duration:t?.duration,icon:t?.icon||"‚è≥",position:t?.position||"top-right"}):null,info:(e,t)=>{window.location.pathname.includes("/admin")&&(0,a.default)(`[ADMIN] ${e}`,{duration:t?.duration||4e3,icon:t?.icon||"‚ÑπÔ∏è",position:t?.position||"top-right"})}},r={success:(e,t)=>{a.default.success(e,{duration:t?.duration||3e3,icon:t?.icon||"‚úÖ",position:t?.position||"top-center"})},error:(e,t)=>{a.default.error(e,{duration:t?.duration||4e3,icon:t?.icon||"‚ùå",position:t?.position||"top-center"})},loading:(e,t)=>a.default.loading(e,{duration:t?.duration,icon:t?.icon||"‚è≥",position:t?.position||"top-center"}),info:(e,t)=>{(0,a.default)(e,{duration:t?.duration||3e3,icon:t?.icon||"‚ÑπÔ∏è",position:t?.position||"top-center"})}}}}]);