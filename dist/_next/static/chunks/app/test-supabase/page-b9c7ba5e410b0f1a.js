(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[192],{2099:(e,r,s)=>{"use strict";s.d(r,{AG:()=>o,HF:()=>i,LC:()=>l,ND:()=>a,aE:()=>m,bf:()=>u,jB:()=>n,ru:()=>d,t1:()=>h,x$:()=>p,zk:()=>c});var t=s(7965);let a=t.LY,o=()=>t.LY,n=async()=>(await (0,t.wT)()).success,i=()=>({hasInstance:!0,attempts:0,url:"netlify-compatible",environment:"netlify-compatible",ready:!0}),l=t.wT;async function c(){try{let{data:e,error:r}=await a.from("customers").select("count",{count:"exact",head:!0});if(r){if(console.error("‚ùå Error de conexi\xf3n Supabase:",r.message),r.message.includes("database is paused")||r.message.includes("project is paused")||r.message.includes("timeout"))throw console.error("\uD83D\uDEA8 Base de datos pausada. Revisa tu plan de Supabase."),Error("Base de datos pausada. Contacta al administrador o actualiza el plan.");return!1}return console.log("‚úÖ Conexi\xf3n Supabase exitosa"),!0}catch(e){return console.error("‚ùå Error cr\xedtico de conexi\xf3n:",e),!1}}async function d(e){try{if(!await c())throw Error("No se pudo establecer conexi\xf3n con la base de datos. Intenta m\xe1s tarde.");console.log("\uD83D\uDCBE Guardando compra:",e);let{data:r,error:s}=await a.from("customers").insert([{name:`${e.nombre} ${e.apellidos}`,email:e.email,phone:e.telefono,city:e.ciudad,state:e.estado}]).select().single();if(s)throw console.error("‚ùå Error al crear cliente:",s),Error(`Error al crear cliente: ${s.message}`);let{data:t,error:o}=await a.from("purchases").insert([{customer_id:r.id,total_amount:e.precio_total,unit_price:e.precio_unitario,discount_applied:e.descuento_aplicado||0,payment_method:e.metodo_pago,payment_reference:e.referencia_pago,payment_proof_url:e.captura_comprobante_url,browser_info:e.navegador,device_info:e.dispositivo,ip_address:e.ip_address,user_agent:e.user_agent,status:"pendiente"}]).select().single();if(o)throw console.error("‚ùå Error al crear compra:",o),Error(`Error al crear compra: ${o.message}`);return console.log("‚úÖ Compra guardada exitosamente"),{customer:r,purchase:t,tickets:[]}}catch(e){throw console.error("‚ùå Error completo en guardarCompra:",e),e}}function u(){return{navegador:navigator.userAgent,dispositivo:/Mobi|Android/i.test(navigator.userAgent)?"m\xf3vil":"escritorio",user_agent:navigator.userAgent,timestamp:new Date().toISOString(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,idioma:navigator.language,pantalla:`${screen.width}x${screen.height}`}}async function m(e,r){try{let s=new Date().getTime(),t=e.name.split(".").pop(),o=`capturas/${r.replace(/\s+/g,"_")}_${s}.${t}`,{data:n,error:i}=await a.storage.from("comprobantes").upload(o,e);if(i)throw console.error("‚ùå Error al subir archivo:",i),i;let{data:l}=a.storage.from("comprobantes").getPublicUrl(o);return console.log("‚úÖ Archivo subido exitosamente"),l.publicUrl}catch(e){return console.error("‚ùå Error en subirCaptura:",e),null}}async function p(){try{let{data:e,error:r}=await a.from("purchases").select(`
        *,
        customer:customers(*),
        tickets(*)
      `).order("created_at",{ascending:!1});if(r)throw console.error("‚ùå Error al obtener compras:",r),r;return e}catch(e){throw console.error("‚ùå Error en obtenerCompras:",e),e}}async function h(e,r,s,t){try{let{data:o,error:n}=await a.from("purchases").select(`
        *,
        customer:customers(*)
      `).eq("id",e).single();if(n)throw n;let i={status:r,notes:s,verified_by:t};"confirmada"===r&&(i.verified_at=new Date().toISOString());let{data:l,error:c}=await a.from("purchases").update(i).eq("id",e).select().single();if(c)throw c;let d=[];if("confirmada"===r){let r=Math.round(l.total_amount/l.unit_price);try{d=await f(e,l.customer_id,r),console.log(`‚úÖ Compra confirmada y ${d.length} tickets asignados`)}catch(r){throw console.error("‚ùå Error al asignar tickets:",r),await a.from("purchases").update({status:"pendiente"}).eq("id",e),Error(`No se pudo confirmar: ${r instanceof Error?r.message:"Error al asignar tickets"}`)}}"cancelada"===r&&(await a.from("tickets").update({status:"disponible",customer_id:null,purchase_id:null,sold_at:null}).eq("purchase_id",e),console.log("\uD83D\uDD04 Tickets liberados por cancelaci\xf3n"));let{data:u,error:m}=await a.from("purchases").select(`
        *,
        customer:customers(*),
        tickets(*)
      `).eq("id",e).single();if(m)throw m;return console.log("‚úÖ Compra actualizada"),u}catch(e){throw console.error("‚ùå Error en actualizarEstadoCompra:",e),e}}async function f(e,r,s){try{let{data:t,error:o}=await a.from("tickets").select("*").eq("status","disponible").order("number").limit(s);if(o)throw o;if(!t||t.length<s)throw Error(`Solo hay ${t?.length||0} tickets disponibles, necesitas ${s}`);let n=t.map(e=>e.number),i=new Date().toISOString(),{data:l,error:c}=await a.from("tickets").update({status:"vendido",customer_id:r,purchase_id:e,sold_at:i}).in("number",n).select();if(c)throw c;return console.log(`‚úÖ Asignados ${l?.length} tickets:`,n),l||[]}catch(e){throw console.error("‚ùå Error al asignar n\xfameros:",e),e}}},7965:(e,r,s)=>{"use strict";s.d(r,{LY:()=>d,wT:()=>c});var t=s(2354),a=s(7358);let o={ANON_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnbWZtbndieW5wcGR6a2h2cmloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4ODE4NzAsImV4cCI6MjA3MTQ1Nzg3MH0.MTNKqQCzmRETjULZ2PRx8mTK3hpR90tn6Pz36h1nMR4",URLS:{DIRECT:"https://ugmfmnwbynppdzkhvrih.supabase.co",POOLER_SESSION:"https://aws-0-us-east-1.pooler.supabase.com",POOLER_TRANSACTION:"https://aws-0-us-east-1.pooler.supabase.com"}};function n(){let e=!!("true"===a.env.NETLIFY||a.env.CONTEXT||a.env.NETLIFY_DEV||window.__NETLIFY__);return{isNetlify:e,hasIPv6Support:"onLine"in navigator,isBuildTime:!1,context:a.env.CONTEXT||"unknown"}}let i=null;function l(){if(i)return i;let e=n(),r=function(){let e=n();return(console.log("\uD83D\uDD0D Environment detection:",e),e.isNetlify)?console.log("\uD83C\uDF10 Using Supavisor Pooler (IPv4) for Netlify compatibility"):console.log("\uD83C\uDF10 Using Direct Connection for local/other environments"),o.URLS.DIRECT}(),s=o.ANON_KEY,a={auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!1,flowType:"pkce"},realtime:{params:{eventsPerSecond:e.isNetlify?1:2}},global:{headers:{"X-Client-Info":"rifa-silverado-netlify@1.0.0","User-Agent":"RifaApp-Netlify/1.0",...e.isNetlify&&{"X-Netlify-Context":e.context,"X-IPv4-Required":"true","X-Pooler-Mode":"session"}},fetch:e.isNetlify?async(e,r)=>{let s=new AbortController,t=setTimeout(()=>s.abort(),6e4);try{let t=await fetch(e,{...r,signal:s.signal,headers:{...r?.headers,Connection:"keep-alive","Cache-Control":"no-cache","Accept-Encoding":"gzip, deflate, br",Accept:"application/json, text/plain, */*"}}),a="string"==typeof e?e:e instanceof URL?e.toString():"request";return console.log(`üì° Supabase request: ${a.substring(0,50)}... ‚Üí ${t.status}`),t}catch(e){throw console.error("‚ùå Netlify Supabase request failed:",e),e}finally{clearTimeout(t)}}:void 0}};return console.log("\uD83D\uDE80 Creating Netlify-compatible Supabase client:",{url:r.substring(0,40)+"...",environment:e,config:"netlify-optimized"}),i=(0,t.UU)(r,s,a)}async function c(){try{let e=l(),r=n();console.log("\uD83E\uDDEA Testing Netlify Supabase connection...");let s=Date.now(),{data:t,error:a}=await e.from("customers").select("count",{count:"exact",head:!0}).limit(1),o=Date.now()-s;if(a){console.error("‚ùå Netlify connection test failed:",a);let e=a.message;return a.message.includes("ENOTFOUND")||a.message.includes("getaddrinfo")?e=`DNS resolution failed - probablemente IPv6 incompatibility en Netlify. Error original: ${a.message}`:a.message.includes("timeout")?e=`Connection timeout en Netlify (${o}ms). Prueba usar Supavisor Pooler.`:a.message.includes("ECONNREFUSED")&&(e="Connection refused - IPv6 address not reachable from Netlify."),{success:!1,error:e,details:{originalError:a.message,environment:r,duration:o,suggestedSolution:"Use IPv4 Supavisor Pooler instead of Direct Connection"}}}return console.log(`‚úÖ Netlify Supabase connection successful (${o}ms)`),{success:!0,details:{environment:r,duration:o,connectionType:r.isNetlify?"ipv4-pooler":"direct"}}}catch(e){return console.error("‚ùå Critical Netlify connection error:",e),{success:!1,error:`Critical error: ${e instanceof Error?e.message:"Unknown error"}`,details:{error:e}}}}let d=l()},8314:(e,r,s)=>{"use strict";s.r(r),s.d(r,{default:()=>l});var t=s(5155),a=s(2115),o=s(6874),n=s.n(o),i=s(2099);function l(){let[e,r]=(0,a.useState)("loading"),[s,o]=(0,a.useState)(""),[l,c]=(0,a.useState)({url:"",key:""}),[d,u]=(0,a.useState)(""),[m,p]=(0,a.useState)(!1);(0,a.useEffect)(()=>{c({url:"https://ugmfmnwbynppdzkhvrih.supabase.co",key:"SET"}),(async()=>{try{let e="https://ugmfmnwbynppdzkhvrih.supabase.co";if(!e||e.includes("placeholder")){r("error"),o("Supabase URL not configured properly");return}let{data:s,error:t}=await i.ND.from("customers").select("count").limit(1);if(t)throw t;r("success")}catch(e){r("error"),o(e?.message||"Error desconocido")}})()},[]);let h=async()=>{p(!0),u("Probando inserci\xf3n de datos...");try{let e={nombre:"Usuario Test",apellidos:"Apellido Test",telefono:"+52 55 1234 5678",email:`test${Date.now()}@example.com`,estado:"CDMX",ciudad:"Ciudad de M\xe9xico",cantidad_boletos:1,numeros_boletos:[1001],precio_unitario:10,precio_total:10,metodo_pago:"Binance Pay"},r=await (0,i.ru)(e);u(`‚úÖ \xa1Inserci\xf3n exitosa!
Customer ID: ${r.customer.id}
Purchase ID: ${r.purchase.id}
Email: ${r.customer.email}`)}catch(e){u(`‚ùå Error al insertar datos:
${e.message}`),console.error("Error completo:",e)}p(!1)},f=async()=>{u("Probando conexi\xf3n detallada...");try{let e=await (0,i.zk)();u(`‚úÖ Conexi\xf3n detallada: ${e?"EXITOSA":"FALLIDA"}`)}catch(e){u(`‚ùå Error de conexi\xf3n detallada:
${e.message}`)}};return(0,t.jsx)("div",{className:"min-h-screen bg-gray-50 p-8",children:(0,t.jsxs)("div",{className:"max-w-2xl mx-auto",children:[(0,t.jsx)("h1",{className:"text-3xl font-bold mb-8",children:"\uD83D\uDD27 Diagn\xf3stico de Supabase"}),(0,t.jsxs)("div",{className:"bg-white rounded-lg p-6 mb-6 shadow",children:[(0,t.jsx)("h2",{className:"text-xl font-bold mb-4",children:"\uD83D\uDCCB Variables de Entorno"}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{children:"SUPABASE_URL:"}),(0,t.jsx)("span",{className:"NOT_SET"===l.url?"text-red-600":"text-green-600",children:"NOT_SET"===l.url?"‚ùå No configurada":"‚úÖ Configurada"})]}),(0,t.jsxs)("div",{className:"flex justify-between",children:[(0,t.jsx)("span",{children:"SUPABASE_ANON_KEY:"}),(0,t.jsx)("span",{className:"NOT_SET"===l.key?"text-red-600":"text-green-600",children:"NOT_SET"===l.key?"‚ùå No configurada":"‚úÖ Configurada"})]}),"NOT_SET"!==l.url&&(0,t.jsxs)("div",{className:"mt-2 text-xs text-gray-600",children:["URL: ",l.url]})]})]}),(0,t.jsxs)("div",{className:"bg-white rounded-lg p-6 mb-6 shadow",children:[(0,t.jsx)("h2",{className:"text-xl font-bold mb-4",children:"\uD83D\uDD17 Estado de Conexi\xf3n"}),"loading"===e&&(0,t.jsxs)("div",{className:"flex items-center gap-2 text-blue-600",children:[(0,t.jsx)("div",{className:"animate-spin w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full"}),"Probando conexi\xf3n..."]}),"success"===e&&(0,t.jsxs)("div",{className:"flex items-center gap-2 text-green-600",children:[(0,t.jsx)("span",{className:"text-xl",children:"‚úÖ"}),"Conexi\xf3n exitosa a Supabase"]}),"error"===e&&(0,t.jsxs)("div",{className:"text-red-600",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,t.jsx)("span",{className:"text-xl",children:"‚ùå"}),"Error de conexi\xf3n"]}),(0,t.jsxs)("div",{className:"bg-red-50 border border-red-200 rounded p-3 text-sm",children:[(0,t.jsx)("strong",{children:"Error:"})," ",s]})]})]}),"success"===e&&(0,t.jsxs)("div",{className:"bg-white rounded-lg p-6 mb-6 shadow",children:[(0,t.jsx)("h2",{className:"text-xl font-bold mb-4",children:"\uD83E\uDDEA Pruebas Adicionales"}),(0,t.jsxs)("div",{className:"space-y-3",children:[(0,t.jsx)("button",{onClick:f,className:"w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors",children:"\uD83D\uDD0D Probar Conexi\xf3n Detallada"}),(0,t.jsx)("button",{onClick:h,disabled:m,className:"w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 disabled:opacity-50 transition-colors",children:m?"‚è≥ Insertando...":"\uD83D\uDCDD Probar Inserci\xf3n de Datos"})]}),d&&(0,t.jsxs)("div",{className:"mt-4 bg-gray-100 border rounded p-3",children:[(0,t.jsx)("h3",{className:"font-bold mb-2",children:"Resultado:"}),(0,t.jsx)("pre",{className:"text-sm whitespace-pre-wrap",children:d})]})]}),(0,t.jsxs)("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-6",children:[(0,t.jsx)("h2",{className:"text-xl font-bold mb-4 text-blue-800",children:"\uD83D\uDCA1 Soluciones"}),"NOT_SET"===l.url||"NOT_SET"===l.key?(0,t.jsxs)("div",{className:"text-blue-700",children:[(0,t.jsx)("p",{className:"mb-2",children:"‚ùå Faltan variables de entorno:"}),(0,t.jsxs)("ol",{className:"list-decimal list-inside space-y-1 text-sm",children:[(0,t.jsxs)("li",{children:["Verifica que existe el archivo ",(0,t.jsx)("code",{children:".env.local"})]}),(0,t.jsxs)("li",{children:["Reinicia el servidor con ",(0,t.jsx)("code",{children:"npm run dev"})]}),(0,t.jsx)("li",{children:"Verifica las credenciales en Supabase"})]})]}):"error"===e?(0,t.jsxs)("div",{className:"text-blue-700",children:[(0,t.jsx)("p",{className:"mb-2",children:"\uD83D\uDD27 Para resolver el error de conexi\xf3n:"}),(0,t.jsxs)("ol",{className:"list-decimal list-inside space-y-1 text-sm",children:[(0,t.jsx)("li",{children:"Ve a tu panel de Supabase"}),(0,t.jsx)("li",{children:"Ejecuta el script SQL del esquema normalizado"}),(0,t.jsxs)("li",{children:["Verifica que las tablas ",(0,t.jsx)("code",{children:"customers"}),", ",(0,t.jsx)("code",{children:"purchases"})," y ",(0,t.jsx)("code",{children:"tickets"})," existen"]}),(0,t.jsx)("li",{children:"Revisa las pol\xedticas RLS est\xe1n configuradas"})]})]}):(0,t.jsxs)("div",{className:"text-green-700",children:[(0,t.jsx)("p",{children:"\uD83C\uDF89 \xa1Todo est\xe1 funcionando correctamente!"}),(0,t.jsxs)("p",{className:"text-sm mt-2",children:["Puedes volver a la ",(0,t.jsx)(n(),{href:"/",className:"underline",children:"p\xe1gina principal"}),"o ir al ",(0,t.jsx)(n(),{href:"/admin",className:"underline",children:"panel de admin"}),"."]})]})]})]})})}},8701:(e,r,s)=>{Promise.resolve().then(s.bind(s,8314))}},e=>{e.O(0,[354,874,441,964,358],()=>e(e.s=8701)),_N_E=e.O()}]);